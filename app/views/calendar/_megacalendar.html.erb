<%
  if use_values_from_session
    js_default_date = session[:mega_calendar_js_default_date]
    js_user_query = session[:mega_calendar_js_user_query]
  else
    js_default_date = Date.today.to_s
    js_user_query = false
  end
  if js_user_query.nil?
    js_user_query = true
    session[:mega_calendar_js_user_query] = js_user_query
  end
  if js_default_date.nil?
    js_default_date = Date.today.to_s
    session[:mega_calendar_js_default_date] = js_default_date
  end
%>

<link rel='stylesheet' href='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/fullcalendar/fullcalendar.css' />
<link rel='stylesheet' href='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/qtip2/jquery.qtip.min.css' />
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/fullcalendar/lib/jquery.min.js'></script>
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/fullcalendar/lib/moment.min.js'></script>
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/fullcalendar/fullcalendar.js'></script>
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/qtip2/jquery.qtip.min.js'></script>
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/fullcalendar/locale-all.js'></script>
<script src='<%= Setting.plugin_mega_calendar['sub_path'] %>plugin_assets/mega_calendar/javascripts/jquery-serialize-object.min.js'></script>

<style>

  .calendar_event {
    pointer:cursor !important;
    color:#000000 !important;
  }

  .calendar_event_closed {
    text-decoration: line-through !important;
    opacity: 0.6 !important;
  }
  @media screen and (max-width: 900px) {
    #calendar {
      padding-left: 5px !important;
      padding-right: 5px !important;
    }
  }
</style>

<h2><%= l(:calendar) %></h2>
<%= render :partial => 'calendar/filter_panel', :locals => {} %>
<center><div id=calendar style="<%= calendar_style %>"></div></center>

<%
  js_locale = User.current.language.downcase  rescue nil
  if js_locale.blank?
    js_locale = Setting.default_language
  end
%>

<script type="text/javascript">
  var user_query = <%= js_user_query.to_s %>;
  function set_active_button(user) {
    var btn_mytickets = $('.fc-myTickets-button');
    var btn_alltickets = $('.fc-allTickets-button');
    if(user === true) {
      btn_mytickets.addClass('fc-state-active');
      btn_alltickets.removeClass('fc-state-active');
    } else {
      btn_mytickets.removeClass('fc-state-active');
      btn_alltickets.addClass('fc-state-active');
    }
  }
  
  $(document).ready(function() {
    $('#calendar').fullCalendar({
        locale: '<%= js_locale %>',
        defaultView: '<%= default_view %>',
        nowIndicator: '<%= default_now_indicator %>',
        navLinks: '<%= default_nav_links %>',
        minTime: '<%= default_min_time %>',
        maxTime: '<%= default_max_time %>',
        height: 'auto',
        selectable: '<%= editable %>' == 'true',
        customButtons: {
                myTickets: {
                        text: '<%= t(:my_issues) %>',
                        click: function() {
                          user_query = true;
                          set_active_button(user_query);
                          $('#calendar').fullCalendar( 'refetchEvents' );
                        }
                },
                allTickets: {
                        text: '<%= t(:all_issues) %>',
                        click: function() {
                          user_query = false;
                          set_active_button(user_query);
                          $('#calendar').fullCalendar( 'refetchEvents' );
                        }
                },
                refresh: {
                  text: '<%= t(:refresh) %>',
                  click: function(){
                    $('#calendar').fullCalendar('refetchEvents');
                  }
                }

        },
        header: {
                        left: '<%= (show_view_buttons == false ? '' : 'prev,next today ' + default_buttons.join(',')) %>',
                        center: 'title',
                        right: '<%= (show_view_buttons == false ? '' : 'month,agendaWeek,agendaDay,listWeek') %>'
                },
        displayEventEnd: true,
        defaultDate: '<%= js_default_date %>',
	firstDay: <%= (Setting.plugin_mega_calendar['week_start'].blank? ? '1' : Setting.plugin_mega_calendar['week_start'].to_s ) %>,
        events: function(start, end, timezone, callback) {
          $.ajax({
            url: '<%= Setting.plugin_mega_calendar['sub_path'] %>calendar/get_events',
            dataType: 'json',
            data: {
              start: start.format("YYYY-MM-DD HH:MM"),
              end: end.format("YYYY-MM-DD HH:MM"),
              user: user_query,
              save_values: <%= use_values_from_session %>,
              filter: $('#calendar_filter').serializeObject()["filter"]
            },
            success: function(doc) {
              var events = [];
              $(doc).each(function() { events.push(this); });
              callback(events);
            }
        });
      },
      eventRender: function(event, element, view) {
          element.qtip({ 
            content: event.description, 
            position: { 
                target: 'mouse',
                my: 'bottom left', 
                adjust: { 
                  x: 5,
                  y: 5
                }
              } 
            });
          if (view.type == 'listWeek') {
            var toInject = [];
            toInject.push(event.status);
            for (var i = 0; i < 1; i++) {	               
                element.append('<td class="fc-list-item-title fc-widget-content">' + toInject[0] + '</td>');
            }          
          }
      },
      resourceRender: function(resourceObj, labelTds, bodyTds) {
        labelTds.eq(0).find('.fc-widget-header');
      },
      eventLimit: true,
      editable: '<%= editable %>' == 'true',
      eventDrop: function(event, delta, revertFunc) {
        if(!confirm("<%= (translate 'save_question') %>")) {
          revertFunc();
        } else {
          var event_begin = event.start.format();
          var event_end = (event.end !== null ? event.end.format() : null);
          var allDay = event.allDay;
          $.get('<%= Setting.plugin_mega_calendar['sub_path'] %>calendar/change_' + event.controller_name, { id: event.id, event_begin: event_begin, event_end: event_end, allDay: allDay });
        }
      },
      eventResize: function(event, delta, revertFunc) {
        if(!confirm("<%= (translate 'save_question') %>")) {
          revertFunc();
        } else {
          $.get('<%= Setting.plugin_mega_calendar['sub_path'] %>calendar/change_' + event.controller_name, { id: event.id, event_begin: event.start.format(), event_end: event.end.format() });
        }
      },
      select: function(start, end) {
        $('#calendar').fullCalendar('unselect');

        <%
          if !Setting.try(:plugin_mega_calendar)[:issue_open_as_project].blank?
            @include_project_id = 'issue[project_id]=' +Setting.try(:plugin_mega_calendar)[:issue_open_as_project] + '&'
          else
            @include_project_id = ''
          end
        %>

        window.open('<%= Setting.plugin_mega_calendar['sub_path'] %>issues/new?<%= @include_project_id.html_safe %>issue[start_date]='+start.format("YYYY-MM-DD")+'&issue[due_date]='+end.format("YYYY-MM-DD")+'&issue[time_begin]='+start.format("HH:mm")+'&issue[time_end]='+end.format("HH:mm"), '_blank');
      },
    });
    set_active_button(user_query);
  });
</script>
